# GophKeeper — Encrypted Record Storage System

GophKeeper — это CLI + сервер для безопасного хранения пользовательских данных.
Все данные шифруются на стороне клиента с использованием индивидуального пользовательского ключа (user-key), который зашифрован master-key сервера.

---

# Возможности

## Серверная часть
- регистрация и авторизация пользователя (JWT)
- генерация индивидуального user-key
- шифрование user-key с помощью master-key (AES‑256‑GCM)
- хранение всех пользовательских данных только в зашифрованном виде
- операции CRUD над записями: создание, чтение, обновление, удаление
- служебные эндпоинты:
  - healthcheck
  - изменение уровня логирования в рантайме

## Клиентская часть
- работа в двух режимах:
  - remote — синхронизация с сервером
  - local — автономная работа с локальной базой BoltDB
- поддерживаемые команды:
  - add, get, getall, update, delete
  - login, register
  - sync — ручная синхронизация с сервером
  - logout — очистка локального состояния

---

# Архитектура шифрования

## Master Key

Сервер использует master-key для шифрования и расшифровки пользовательских ключей.
Сгенерировать master-key можно командой:

```bash
make master-key
```

Результат — 32 байта (AES‑256), закодированные в base64.

## User Key

При регистрации:

1. Генерируется случайный 32‑байтовый user-key.
2. user-key шифруется master-key.
3. encrypted-user-key сохраняется в базе данных.
4. сам user-key в открытом виде не хранится.

## Процесс работы с записью

1. Клиент расшифровывает/шифрует данные локально.
2. Клиент отправляет только зашифрованные данные.
3. Сервер хранит только шифртекст.

---

# Локальный режим (BoltDB)

Если не передавать `--remote`, клиент работает локально:

- CRUD выполняется без сервера
- данные хранятся в BoltDB зашифрованными user-key
- сервер не участвует

Путь к локальной базе:

```
~/.config/gophkeeper/data.db
```

---

# Авторизация и токен

При login:

1. Клиент получает JWT.
2. JWT сохраняется в `.gophkeeper_token`.
3. Клиент получает encrypted user-key.
4. user-key расшифровывается и сохраняется в BoltDB.
5. локальная база синхронизируется с серверной.

Ручная синхронизация:

```bash
gophkeeper record sync
```

---

# Мультипользовательность

Локальная работа поддерживает только одного пользователя.

Для завершения работы:

```bash
gophkeeper logout
```

Это удаляет:
- токен
- локальную базу данных

---

# Абстрактная схема взаимодействия

## Новый пользователь

```
Клиент ── register ──► Сервер
           ▲             │
           │             │ генерирует user-key
           │             │ шифрует master-key'ем
           │             ▼
           ◄────── user-id + jwt ──────
Клиент ── login ─► получает encrypted user-key
           │
           │ расшифровывает user-key
           │ сохраняет в BoltDB
           ▼
полноценная работа
```

## Существующий пользователь

```
Клиент → login
        ← jwt + encrypted user-key
расшифровка user-key
sync локальной BoltDB
CRUD-операции:
    get → receive encrypted → decrypt (local)
    add → encrypt → send (remote)
    update → encrypt → send (remote)
    delete → send id (remote)
```

локально можно только читать
все остальные действия должны происходить на сервере
---

# Установка и запуск

## Сервер

```bash
go run cmd/server/main.go
```

или:

```bash
docker-compose up --build
```

## Клиент

```bash
go run cmd/client/main.go --help
```

---

# Динамическое изменение уровня логирования

## Получить текущий уровень логов

```
GET /debug/loglevel
```

Ответ:

```json
{ "level": "debug" }
```

## Установить уровень логов

```
POST /debug/loglevel
Content-Type: application/json

{ "level": "warn" }
```

Поддерживаемые уровни: debug, info, warn, error, dpanic, panic, fatal.

---

# Healthcheck

```
GET /healthcheck
```

Ответ:

```json
{ "status": "ok" }
```

Используется для readiness/liveness.

---

# Graceful Shutdown (errgroup)

Сервер корректно завершает работу:

- закрывает HTTP-сервер
- закрывает gRPC-сервер
- завершает открытые соединения
- корректно обрабатывает SIGINT/SIGTERM

Используется `errgroup.WithContext`.

---

# HTTP API сервера

## Пользователь (без авторизации)

| Метод | Путь | Описание |
|-------|------|----------|
| POST | /api/user/register | Регистрация |
| POST | /api/user/login | Авторизация, выдача JWT и user-key |
| POST | /api/user/logout | Завершение сессии |

## Записи пользователя (JWT обязателен)

| Метод | Путь | Описание |
|-------|------|----------|
| POST | /api/record | Создание записи |
| GET | /api/records | Получение всех записей |
| GET | /api/records/{id} | Получение записи |
| PATCH | /api/records/{id} | Обновление записи |
| DELETE | /api/records/{id} | Удаление записи |

## Отладка

| Метод | Путь | Описание |
|-------|------|----------|
| GET | /debug/loglevel | Получить уровень логов |
| POST | /debug/loglevel | Изменить уровень логов |
